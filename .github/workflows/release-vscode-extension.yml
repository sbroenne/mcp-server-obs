name: Release VS Code Extension

# This workflow builds and releases the OBS MCP VS Code extension
# Triggered by pushing tags matching 'vscode-v*'

on:
  push:
    tags:
      - 'vscode-v*'

jobs:
  release-vscode-extension:
    runs-on: windows-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Update MCP Server Version
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^vscode-v', ''

        Write-Output "Updating MCP Server to version $version for bundled executable"
        
        # Update MCP Server project version
        $mcpCsprojPath = "src/ObsMcp.McpServer/ObsMcp.McpServer.csproj"
        $mcpContent = Get-Content $mcpCsprojPath -Raw
        $mcpContent = $mcpContent -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $mcpContent = $mcpContent -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $mcpContent = $mcpContent -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $mcpCsprojPath $mcpContent

        Write-Output "Updated MCP Server project to version $version"
      shell: pwsh

    - name: Update Extension Version
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^vscode-v', ''

        Write-Output "Updating VS Code extension to version $version"

        # Update package.json version
        cd vscode-extension
        npm version "$version" --no-git-tag-version

        # Update CHANGELOG.md - replace the first version number and date
        $date = Get-Date -Format 'yyyy-MM-dd'
        $changelogPath = 'CHANGELOG.md'
        if (Test-Path $changelogPath) {
          $changelogContent = Get-Content $changelogPath -Raw
          $changelogContent = $changelogContent -replace '(?m)^## \[\d+\.\d+\.\d+\] - \d{4}-\d{2}-\d{2}', "## [$version] - $date"
          Set-Content $changelogPath $changelogContent
        }

        Write-Output "Updated extension version to $version"
        "PACKAGE_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Install Dependencies
      run: |
        cd vscode-extension
        npm install

    - name: Build and Package Extension
      run: |
        cd vscode-extension
        # Run the package script which does: build:mcp-server + vsce package
        npm run package

        $version = "${{ env.PACKAGE_VERSION }}"

        # vsce creates filename based on package.json name
        $actualVsix = Get-ChildItem -Path . -Filter "*.vsix" -File | Select-Object -First 1
        if (-not $actualVsix) {
          Write-Error "No VSIX file found"
          exit 1
        }

        $targetName = "obs-mcp-server-$version.vsix"
        if ($actualVsix.Name -ne $targetName) {
          Rename-Item $actualVsix.FullName -NewName $targetName
          Write-Output "Renamed $($actualVsix.Name) to $targetName"
        }

        Write-Output "Created $targetName"
        Get-Item $targetName | Format-Table Name, Length
        "VSIX_PATH=vscode-extension/$targetName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Publish to VS Code Marketplace
      uses: HaaLeo/publish-vscode-extension@v2
      with:
        pat: ${{ secrets.VSCE_TOKEN }}
        registryUrl: https://marketplace.visualstudio.com
        extensionFile: ${{ env.VSIX_PATH }}
      continue-on-error: true
      id: publishToMarketplace

    - name: Create GitHub Release
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = "${{ env.PACKAGE_VERSION }}"
        $vsixFile = "${{ env.VSIX_PATH }}"

        $marketplaceStatus = "Not published"
        if ("${{ steps.publishToMarketplace.outcome }}" -eq "success") {
          $marketplaceStatus = "Published to VS Code Marketplace"
        }

        $notes = "## OBS MCP Server VS Code Extension $tagName`n`n"
        $notes += "### Control OBS Studio from VS Code with AI`n`n"
        $notes += "This extension registers the OBS MCP server with VS Code, enabling AI assistants to control OBS Studio.`n`n"
        $notes += "### Installation Options`n`n"
        $notes += "**Option 1: VS Code Marketplace** - Search for 'OBS MCP Server' and click Install`n"
        $notes += "**Option 2: Manual VSIX** - Download obs-mcp-server-$version.vsix below and install via VS Code`n`n"
        $notes += "### Publishing Status: $marketplaceStatus`n`n"
        $notes += "### Key Features`n"
        $notes += "- Zero Configuration - Automatic MCP server registration`n"
        $notes += "- Control recordings, streaming, and scenes`n"
        $notes += "- Window and display capture management`n"
        $notes += "- Screenshot and virtual camera support`n"
        $notes += "- Works in all VS Code workspaces`n`n"
        $notes += "### Requirements`n"
        $notes += "- Windows OS`n"
        $notes += "- OBS Studio with WebSocket server enabled`n"
        $notes += "- VS Code 1.106.0+`n`n"
        $notes += "### Documentation`n"
        $notes += "- [Main Repository](https://github.com/sbroenne/mcp-server-obs)`n"

        $notes | Out-File -FilePath "release_notes.md" -Encoding utf8

        gh release create "$tagName" "$vsixFile" --title "OBS MCP Server VS Code Extension $tagName" --notes-file release_notes.md

        Write-Output "Released OBS MCP Server VS Code Extension $version"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh
