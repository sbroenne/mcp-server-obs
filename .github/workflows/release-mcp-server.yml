name: Release MCP Server

# This workflow builds and releases the standalone OBS Studio MCP Server
# Triggered by pushing tags matching 'mcp-v*'

on:
  push:
    tags:
      - 'mcp-v*'

jobs:
  release-mcp-server:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Extract Version
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^mcp-v', ''
        Write-Output "Version: $version"
        "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Update Version in Project
      run: |
        $version = "${{ env.VERSION }}"
        $csprojPath = "src/ObsMcp.McpServer/ObsMcp.McpServer.csproj"
        $content = Get-Content $csprojPath -Raw
        $content = $content -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $content = $content -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $content = $content -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $csprojPath $content
        Write-Output "Updated project to version $version"
      shell: pwsh

    - name: Restore Dependencies
      run: dotnet restore

    - name: Run Tests
      run: dotnet test --filter "Category!=Integration" --no-restore

    - name: Publish (Portable)
      run: dotnet publish src/ObsMcp.McpServer/ObsMcp.McpServer.csproj -c Release -o publish

    - name: Create Release Archive
      run: |
        $version = "${{ env.VERSION }}"
        
        Compress-Archive -Path "publish/*" -DestinationPath "obs-mcp-server-$version.zip"
        
        Write-Output "Created release archive"
        Get-ChildItem *.zip | Format-Table Name, Length
      shell: pwsh

    - name: Create GitHub Release
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = "${{ env.VERSION }}"
        
        $notes = @"
        ## OBS Studio MCP Server $tagName
        
        MCP server for controlling OBS Studio via Model Context Protocol.
        
        ### Download
        
        | File | Description |
        |------|-------------|
        | obs-mcp-server-$version.zip | Cross-platform, requires [.NET 8 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) |
        
        ### Available Tools (7 resource-based)
        
        | Tool | Actions |
        |------|---------|
        | obs_connection | Connect, Disconnect, GetStatus, GetStats |
        | obs_recording | Start, Stop, Pause, Resume, GetStatus, GetSettings, SetFormat, SetQuality, SetPath, GetPath |
        | obs_streaming | Start, Stop, GetStatus |
        | obs_scene | List, GetCurrent, Set, ListSources |
        | obs_source | AddWindowCapture, ListWindows, SetWindowCapture, Remove, SetEnabled |
        | obs_audio | GetInputs, Mute, Unmute, GetMuteState, SetVolume, GetVolume, MuteAll, UnmuteAll |
        | obs_media | TakeScreenshot, StartVirtualCamera, StopVirtualCamera |
        
        > **Note:** Recording starts with audio **muted** by default. Use muteAudio=false to include audio.
        
        ### Installation
        
        1. Install [.NET 8 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0)
        2. Extract the zip to a folder
        3. Run with ``dotnet Sbroenne.ObsMcp.McpServer.dll`` or add to your MCP client config
        
        See [README](https://github.com/sbroenne/mcp-server-obs/blob/main/README.md) for full documentation.
        "@
        
        $notes | Out-File -FilePath "release_notes.md" -Encoding utf8
        
        gh release create "$tagName" `
          "obs-mcp-server-$version.zip" `
          --title "OBS Studio MCP Server $tagName" `
          --notes-file release_notes.md
        
        Write-Output "Released OBS Studio MCP Server $version"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh
