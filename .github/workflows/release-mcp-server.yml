name: Release MCP Server

# This workflow builds and releases the standalone OBS MCP Server
# Triggered by pushing tags matching 'mcp-v*'

on:
  push:
    tags:
      - 'mcp-v*'

jobs:
  release-mcp-server:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Extract Version
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^mcp-v', ''
        Write-Output "Version: $version"
        "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Update Version in Project
      run: |
        $version = "${{ env.VERSION }}"
        $csprojPath = "src/ObsMcp.McpServer/ObsMcp.McpServer.csproj"
        $content = Get-Content $csprojPath -Raw
        $content = $content -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $content = $content -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $content = $content -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $csprojPath $content
        Write-Output "Updated project to version $version"
      shell: pwsh

    - name: Restore Dependencies
      run: dotnet restore

    - name: Run Tests
      run: dotnet test --filter "Category!=Integration" --no-restore

    - name: Publish Self-Contained (Windows x64)
      run: |
        dotnet publish src/ObsMcp.McpServer/ObsMcp.McpServer.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -o publish/win-x64
      shell: pwsh

    - name: Publish Framework-Dependent (Windows x64)
      run: |
        dotnet publish src/ObsMcp.McpServer/ObsMcp.McpServer.csproj `
          -c Release `
          -r win-x64 `
          --self-contained false `
          -o publish/win-x64-fdd
      shell: pwsh

    - name: Create Release Archives
      run: |
        $version = "${{ env.VERSION }}"
        
        # Self-contained (larger, no .NET required)
        Compress-Archive -Path "publish/win-x64/*" -DestinationPath "obs-mcp-server-$version-win-x64-self-contained.zip"
        
        # Framework-dependent (smaller, requires .NET 8 runtime)
        Compress-Archive -Path "publish/win-x64-fdd/*" -DestinationPath "obs-mcp-server-$version-win-x64.zip"
        
        Write-Output "Created release archives"
        Get-ChildItem *.zip | Format-Table Name, Length
      shell: pwsh

    - name: Create GitHub Release
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = "${{ env.VERSION }}"
        
        $notes = @"
        ## OBS MCP Server $tagName
        
        Standalone MCP server for controlling OBS Studio via Model Context Protocol.
        
        ### Download Options
        
        | File | Description |
        |------|-------------|
        | obs-mcp-server-$version-win-x64-self-contained.zip | **Recommended** - Includes .NET runtime, no dependencies |
        | obs-mcp-server-$version-win-x64.zip | Smaller download, requires [.NET 8 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0) |
        
        ### Available Tools (6 resource-based)
        
        | Tool | Actions |
        |------|---------|
        | obs_connection | Connect, Disconnect, GetStatus, GetStats |
        | obs_recording | Start, Stop, Pause, Resume, GetStatus, GetSettings, SetFormat, SetQuality |
        | obs_streaming | Start, Stop, GetStatus |
        | obs_scene | List, GetCurrent, Set, ListSources |
        | obs_source | AddWindowCapture, ListWindows, SetWindowCapture, Remove, SetEnabled |
        | obs_media | TakeScreenshot, StartVirtualCamera, StopVirtualCamera |
        
        ### Installation
        
        1. Extract the zip to a folder (e.g., ``C:\Tools\obs-mcp-server``)
        2. Add to your MCP client config (Claude Desktop, VS Code, Cursor, etc.)
        
        Example mcp.json:
        ``````json
        {
          "servers": {
            "obs": {
              "command": "C:/Tools/obs-mcp-server/Sbroenne.ObsMcp.McpServer.exe",
              "env": {
                "OBS_HOST": "localhost",
                "OBS_PORT": "4455",
                "OBS_PASSWORD": "your_password"
              }
            }
          }
        }
        ``````
        
        ### Requirements
        
        - Windows 10/11
        - OBS Studio with WebSocket server enabled
        - .NET 8 Runtime (only for framework-dependent version)
        
        ### Documentation
        
        See [README](https://github.com/sbroenne/mcp-server-obs/blob/main/README.md) for full documentation.
        "@
        
        $notes | Out-File -FilePath "release_notes.md" -Encoding utf8
        
        gh release create "$tagName" `
          "obs-mcp-server-$version-win-x64-self-contained.zip" `
          "obs-mcp-server-$version-win-x64.zip" `
          --title "OBS MCP Server $tagName" `
          --notes-file release_notes.md
        
        Write-Output "Released OBS MCP Server $version"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh
